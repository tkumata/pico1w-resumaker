# 仕様書 (SPECIFICATIONS)

## 1. DNS サーバー仕様 (`dns.py`)

- **ポート**: UDP 53
- **挙動**: 受信した全ての A レコードクエリに対し、コンストラクタで指定された IP アドレス (デフォルト `192.168.4.1`) を返す。
- **メモリ管理**: メモリ不足を防ぐため、リクエスト処理ごとに適切にガベージコレクションやリソース解放を行うこと（既存実装済み想定）。

## 2. Web サーバー仕様 (`web.py`)

### 2.1. キャプティブポータル検知ロジック (`handle_client` 内)

リクエスト処理の初期段階（ルーティング前）に以下のチェックを行う。

1.  **Host ヘッダーチェック**:

    - `Host` ヘッダーが存在し、かつ `192.168.4.1` (または設定された自 IP) **でない**場合:
      - `http://192.168.4.1/` へ 302 リダイレクトする。

2.  **特定パスのインターセプト**:
    - 以下のパスへのアクセスは、実ファイルが存在しなくても優先的に処理する。
    - `/generate_204` (Android): `http://192.168.4.1/` へ 302 リダイレクト。
    - `/gen_204` (Android): `http://192.168.4.1/` へ 302 リダイレクト。
    - `/hotspot-detect.html` (iOS/macOS):
      - 現状: `www/hotspot-detect.html` (メタタグリダイレクト付き) を返している。
      - 変更: そのままで良いが、明示的に `index.html` へ 302 リダイレクトしても良い。Apple は "Success" という文字列がない場合ポータルとみなすため、履歴書ページ自体を返しても良いが、リダイレクトの方が挙動が安定する場合がある。今回は統一して 302 リダイレクトとする。
    - `/ncsi.txt` (Windows): 302 リダイレクト、または 404 以外の任意の応答（ポータルと認識させるため）。

### 2.2. ルーティング優先順位

1.  **API エンドポイント** (`/api/...`, `/admin/...`): 既存通り処理。
2.  **静的ファイル** (`/`, `/index.html`, `/style.css` 等): 既存通り `www/` 以下のファイルを提供。
3.  **キャプティブポータル判定**: 上記に当てはまらない、かつ `Host` が異なる、または特定の検知用パスの場合 -> **302 Redirect to root**。
4.  **404 Not Found**: 上記いずれにも当てはまらず、ローカルファイルも存在しない場合。

### 2.3. レスポンスヘッダー

リダイレクト時のレスポンス:

```http
HTTP/1.1 302 Found
Location: http://192.168.4.1/
Connection: close
```

## 3. 実装ステップ (`main.py`)

- `dns.py` のインポートのコメントアウトを解除。
- `DNSServer` のインスタンス化 (`dns_server = DNSServer(ip=ap.ifconfig()[0])`) のコメントアウトを解除。
- `asyncio.gather` 内の `dns_server.start()` のコメントアウトを解除。
