# 要件定義

## 目的

- 例外処理の適正化とファイルベースのログ記録を導入する。
- OLED の状態管理をクラス化して可読性と保守性を向上させる。
- /admin/jobhist の保存時メモリエラーと CSV 空化を防止する。

## 機能要件

### ログ記録

- エラーログは Flash に `/log.txt` として保存する。
- ログの最大サイズは 5KB とする。
- サイズ超過時はログ内容をクリアしてから追記する。
- ログ閲覧は Web 管理画面から行えること。

### 例外処理

- `web.py` の `handle_client` で広い例外キャッチを分解する。
- `MemoryError` は `gc.collect()` 実行後に 503 を返す。
- `OSError` は 500 を返す。
- `ValueError` は 400 を返す。
- 予期せぬ例外は 500 を返す。
- 例外内容はログに記録する。

### ログ閲覧

- `/admin/log` で `/log.txt` の中身を素出しで返す。

### 表示制御

- `display.py` の状態を `DisplayController` に集約する。
- 表示サイクルは 120 秒 ON、1 秒 OFF を維持する。
- QR 生成後に `unload_modules()` を呼び出す。

### 職務経歴保存

- /admin/jobhist の保存時にメモリエラーを起こしにくい実装にする。
- データが 0 件の保存要求は既存の jobhist.csv を保持する。

## 非機能要件

- MicroPython 環境で動作すること。
- 既存の動作や機能を大きく変えない。
- `secrets.py` を新規に書き換えない。
