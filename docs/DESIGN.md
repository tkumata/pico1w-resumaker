# 設計書 (DESIGN)

## アーキテクチャ概要

既存の `main.py`, `dns.py`, `web.py` を改修し、キャプティブポータル機能を実現する。
DNS サーバーで全てのトラフィックを自身に向け、Web サーバーで接続確認リクエストを捕捉してメインページへ誘導する方式を採用する。

## コンポーネント設計

### 1. DNS サーバー (`dns.py`)
- **現状**: すでにすべてのクエリに対して自身の IP を返す実装が存在する。
- **変更点**: `main.py` でコメントアウトされている初期化と起動処理を有効化する。
- **動作**: UDP 53 番ポートで待受し、受信した DNS クエリ (A レコード) に対して、常に AP の IP アドレスを回答する。

### 2. Web サーバー (`web.py`)
- **現状**: 特定のパス (`routes` に定義) と静的ファイル (`www/`) へのアクセスのみを処理。それ以外は 404 エラー。
- **変更点**:
  - **キャッチオール (Catch-all) リダイレクト**: リクエストされた `Host` ヘッダーが自身の IP アドレスでない場合、またはリクエストパスが既知の静的ファイルや API でない場合、`http://192.168.4.1/` への 302 リダイレクトを行う。
  - **特定の接続確認パスへの対応**: OS が接続確認に使用する特定のパス (例: `/generate_204`, `/hotspot-detect.html`) へのアクセスに対し、適切なレスポンス (リダイレクト または 200 OK でポータルページ表示) を返す。

### 3. メイン処理 (`main.py`)
- `DNSServer` のインスタンス化と `asyncio` ループへの組み込みを行う。

## シーケンス

1. **Wi-Fi 接続**: ユーザー端末が Pico W の AP に接続。
2. **IP 取得**: DHCP により IP アドレス取得（Pico W 内部の DHCP サーバー機能利用）。DNS サーバーとして Pico W の IP が通知される。
3. **接続確認 (Captive Portal Check)**:
   - 端末 OS が特定の URL (例: `http://connectivitycheck.gstatic.com/generate_204`) へアクセスを試行。
4. **名前解決**:
   - 端末が DNS サーバー (Pico W) にドメイン名の解決を要求。
   - `dns.py` が Pico W の IP アドレス (192.168.4.1) を返す。
5. **HTTP リクエスト**:
   - 端末が `http://connectivitycheck.gstatic.com/generate_204` (IP: 192.168.4.1) へ GET リクエストを送信。
6. **Web サーバー処理**:
   - `web.py` がリクエストを受信。
   - パス `/generate_204` または Host `connectivitycheck.gstatic.com` を検知。
   - `http://192.168.4.1/` への 302 Found (Redirect) を返却。
7. **ポータル表示**:
   - 端末のブラウザ（またはキャプティブポータル専用ミニブラウザ）が `http://192.168.4.1/` へアクセス。
   - `web.py` が `index.html` を返却。
   - 画面に履歴書が表示される。

## 注意事項
- **Android**: `generate_204` に対してリダイレクトを返すとポータルとして認識されることが多い。
- **iOS**: `hotspot-detect.html` へのアクセスに対し、"Success" という文字列**以外**を含む HTML (ポータルページ) を返すと、ポータル画面が開く。
- **Windows**: `ncsi.txt` へのアクセスに対し、期待するテキスト以外を返すとポータルと認識する。